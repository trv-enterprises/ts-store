openapi: 3.0.3
info:
  title: ts-store API
  description: |
    Time series database API using a circular file architecture.

    ## Authentication

    ts-store uses two types of authentication:

    ### Admin Key (for store management)
    Required for creating new stores. Pass via:
    - Header: `X-Admin-Key: <admin-key>`
    - Query parameter: `?admin_key=<admin-key>`

    The admin key is configured at server startup (min 20 characters).

    ### Store API Key (for data operations)
    Required for all data operations on a store. Pass via (checked in order):
    - Header: `X-API-Key: tsstore_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
    - Header: `Authorization: Bearer tsstore_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`
    - Query parameter: `?api_key=tsstore_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`

    Store API keys are generated when creating a store and shown only once.

    ## TLS/HTTPS
    The server supports optional TLS. When configured with certificate and key files,
    all HTTP endpoints use HTTPS and WebSocket endpoints use WSS.

    ## Timestamps
    All timestamps are Unix nanoseconds (int64). Timestamps must be strictly increasing - out-of-order timestamps will be rejected.

    ## Duration Format
    The `since` parameter accepts durations like: `30s`, `15m`, `2h`, `7d`, `1w`
  version: 0.1.0
  license:
    name: Business Source License 1.1
  contact:
    name: TRV Enterprises LLC

servers:
  - url: http://localhost:21080
    description: Local development server (HTTP)
  - url: https://localhost:21080
    description: Local development server (HTTPS, if TLS configured)

tags:
  - name: Health
    description: Server health check
  - name: Stores
    description: Store management operations
  - name: Data
    description: Unified data operations (Content-Type determines format)
  - name: Schema
    description: Schema management for schema-type stores

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns server health status. No authentication required.
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  time:
                    type: string
                    format: date-time
                    example: "2026-01-17T12:00:00Z"

  /api/stores:
    get:
      tags:
        - Stores
      summary: List open stores
      description: Returns a list of currently open stores.
      responses:
        '200':
          description: List of stores
          content:
            application/json:
              schema:
                type: object
                properties:
                  stores:
                    type: array
                    items:
                      type: string
                    example: ["my-store", "sensor-data"]

    post:
      tags:
        - Stores
      summary: Create a new store
      description: |
        Creates a new store and returns the API key.
        **Important:** The API key is shown only once. Save it securely.

        Requires admin authentication via `X-Admin-Key` header or `admin_key` query parameter.
      security:
        - AdminKeyHeader: []
        - AdminKeyQuery: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStoreRequest'
      responses:
        '201':
          description: Store created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateStoreResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Missing or invalid admin key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: admin key required
        '409':
          description: Store already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/stores/{store}:
    delete:
      tags:
        - Stores
      summary: Delete a store
      description: Permanently deletes a store and all its data.
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
      responses:
        '200':
          description: Store deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: store deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/stores/{store}/stats:
    get:
      tags:
        - Stores
      summary: Get store statistics
      description: Returns detailed statistics about the store.
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
      responses:
        '200':
          description: Store statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreStats'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/stores/{store}/data:
    post:
      tags:
        - Data
      summary: Insert data
      description: |
        Insert data with optional timestamp. Content-Type header determines format:
        - `application/json`: JSON body with `{"timestamp": ..., "data": ...}` wrapper
        - `application/octet-stream`: Raw binary body (timestamp auto-generated)
        - `text/plain`: Raw text body (timestamp auto-generated)

        For schema-type stores, data is validated against the schema and stored compactly.
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InsertJSONRequest'
          application/octet-stream:
            schema:
              type: string
              format: binary
          text/plain:
            schema:
              type: string
      responses:
        '201':
          description: Data inserted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InsertResponse'
        '400':
          description: Invalid request, data type mismatch, or out-of-order timestamp
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '415':
          description: Unsupported content type
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/stores/{store}/data/time/{timestamp}:
    get:
      tags:
        - Data
      summary: Get data by timestamp
      description: Retrieve data by its exact timestamp.
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
        - $ref: '#/components/parameters/Timestamp'
        - $ref: '#/components/parameters/Format'
      responses:
        '200':
          description: Data found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      tags:
        - Data
      summary: Delete data by timestamp
      description: |
        Soft delete - excludes data from API responses and WebSocket streams.
        The data remains on disk until the block is overwritten as the circular buffer wraps.
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
        - $ref: '#/components/parameters/Timestamp'
      responses:
        '200':
          description: Data deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: object deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/stores/{store}/data/range:
    get:
      tags:
        - Data
      summary: Query data in time range
      description: |
        Retrieve data within a time range. Use either:
        - `since` parameter for relative time (e.g., `since=2h`)
        - `start_time` and `end_time` for absolute timestamps
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
        - $ref: '#/components/parameters/Limit100'
        - $ref: '#/components/parameters/Since'
        - name: start_time
          in: query
          schema:
            type: integer
            format: int64
          description: Start timestamp (Unix nanoseconds). Required if `since` not provided.
        - name: end_time
          in: query
          schema:
            type: integer
            format: int64
          description: End timestamp (Unix nanoseconds). Required if `since` not provided.
        - $ref: '#/components/parameters/IncludeData'
        - $ref: '#/components/parameters/Filter'
        - $ref: '#/components/parameters/FilterIgnoreCase'
        - $ref: '#/components/parameters/Format'
      responses:
        '200':
          description: Data in range
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataListResponse'
        '400':
          description: Missing or invalid parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/stores/{store}/data/oldest:
    get:
      tags:
        - Data
      summary: List oldest data objects
      description: Returns the N oldest data objects. Use `include_data=true` to include the actual data content.
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/IncludeData'
        - $ref: '#/components/parameters/Filter'
        - $ref: '#/components/parameters/FilterIgnoreCase'
        - $ref: '#/components/parameters/Format'
      responses:
        '200':
          description: List of data objects
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/stores/{store}/data/newest:
    get:
      tags:
        - Data
      summary: List newest data objects
      description: Returns the N newest data objects. Supports relative time queries with `since` parameter. Use `include_data=true` to include the actual data content.
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Since'
        - $ref: '#/components/parameters/IncludeData'
        - $ref: '#/components/parameters/Filter'
        - $ref: '#/components/parameters/FilterIgnoreCase'
        - $ref: '#/components/parameters/Format'
      responses:
        '200':
          description: List of data objects
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataListResponse'
        '400':
          description: Invalid since duration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/stores/{store}/schema:
    get:
      tags:
        - Schema
      summary: Get schema
      description: Returns the current schema for schema-type stores.
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
      responses:
        '200':
          description: Schema found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SchemaResponse'
        '400':
          description: Store is not a schema-type store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: No schema defined
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Schema
      summary: Set or update schema
      description: |
        Sets or updates the schema for schema-type stores.
        For updates, the new schema must be append-only compatible (existing fields cannot be modified or removed).
      security:
        - ApiKeyHeader: []
        - BearerAuth: []
        - ApiKeyQuery: []
      parameters:
        - $ref: '#/components/parameters/StoreName'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SchemaRequest'
            example:
              fields:
                - index: 1
                  name: temperature
                  type: float32
                - index: 2
                  name: humidity
                  type: float32
      responses:
        '200':
          description: Schema updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: schema updated
                  version:
                    type: integer
                    example: 1
        '400':
          description: Invalid schema or not a schema-type store
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    ApiKeyHeader:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key in X-API-Key header
    BearerAuth:
      type: http
      scheme: bearer
      description: API key in Authorization Bearer header
    ApiKeyQuery:
      type: apiKey
      in: query
      name: api_key
      description: API key in query parameter
    AdminKeyHeader:
      type: apiKey
      in: header
      name: X-Admin-Key
      description: Admin key for store management operations
    AdminKeyQuery:
      type: apiKey
      in: query
      name: admin_key
      description: Admin key in query parameter

  parameters:
    StoreName:
      name: store
      in: path
      required: true
      schema:
        type: string
      description: Store name
      example: my-store

    Timestamp:
      name: timestamp
      in: path
      required: true
      schema:
        type: integer
        format: int64
      description: Unix timestamp in nanoseconds
      example: 1704067200000000000

    Limit:
      name: limit
      in: query
      schema:
        type: integer
        default: 10
        minimum: 1
      description: Maximum number of results to return

    Limit100:
      name: limit
      in: query
      schema:
        type: integer
        default: 100
        minimum: 1
      description: Maximum number of results to return

    Since:
      name: since
      in: query
      schema:
        type: string
      description: Relative time duration (e.g., 30s, 15m, 2h, 7d, 1w)
      example: 2h

    IncludeData:
      name: include_data
      in: query
      schema:
        type: boolean
        default: false
      description: Include the actual data content in the response

    Filter:
      name: filter
      in: query
      schema:
        type: string
      description: Text filter - only return objects containing this string

    FilterIgnoreCase:
      name: filter_ignore_case
      in: query
      schema:
        type: boolean
        default: false
      description: Make text filter case-insensitive

    Format:
      name: format
      in: query
      schema:
        type: string
        enum: [compact, expanded]
        default: expanded
      description: For schema stores, 'compact' returns numeric field indices, 'expanded' returns field names

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
          example: error message

    CreateStoreRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          description: Store name
          example: my-store
        num_blocks:
          type: integer
          default: 1024
          description: Number of blocks
        data_block_size:
          type: integer
          default: 4096
          description: Data block size in bytes (must be power of 2)
        index_block_size:
          type: integer
          default: 4096
          description: Index block size in bytes (must be power of 2)

    CreateStoreResponse:
      type: object
      properties:
        name:
          type: string
          example: my-store
        api_key:
          type: string
          description: API key (shown only once)
          example: tsstore_a1b2c3d4-e5f6-7890-abcd-ef1234567890
        key_id:
          type: string
          description: Key ID for reference
          example: a1b2c3d4

    StoreStats:
      type: object
      properties:
        num_blocks:
          type: integer
          format: uint32
          example: 1024
        data_block_size:
          type: integer
          format: uint32
          example: 4096
        index_block_size:
          type: integer
          format: uint32
          example: 4096
        head_block:
          type: integer
          format: uint32
          example: 50
        tail_block:
          type: integer
          format: uint32
          example: 0
        free_list_count:
          type: integer
          format: uint32
          example: 0
        write_offset:
          type: integer
          format: uint32
          example: 128
        active_blocks:
          type: integer
          format: uint32
          example: 51
        oldest_timestamp:
          type: integer
          format: int64
          example: 1704067200000000000
        oldest_time:
          type: string
          example: "2024-01-01T00:00:00Z"
        newest_timestamp:
          type: integer
          format: int64
          example: 1704153600000000000
        newest_time:
          type: string
          example: "2024-01-02T00:00:00Z"

    InsertJSONRequest:
      type: object
      required:
        - data
      properties:
        timestamp:
          type: integer
          format: int64
          description: Unix timestamp in nanoseconds (optional, defaults to now)
        data:
          description: JSON data to store
          oneOf:
            - type: object
            - type: array
            - type: string
            - type: number
            - type: boolean

    InsertResponse:
      type: object
      properties:
        timestamp:
          type: integer
          format: int64
          example: 1704067200000000000
        block_num:
          type: integer
          format: uint32
          example: 5
        size:
          type: integer
          format: uint32
          example: 64

    DataResponse:
      type: object
      description: A data object with optional data content
      properties:
        timestamp:
          type: integer
          format: int64
          example: 1704067200000000000
        block_num:
          type: integer
          format: uint32
          example: 5
        size:
          type: integer
          format: uint32
          example: 64
        data:
          description: |
            Data content (only present if include_data=true).
            Format depends on store type:
            - binary: base64-encoded string
            - text: UTF-8 string
            - json: JSON object
            - schema: JSON object with field names (or numeric indices if format=compact)
          oneOf:
            - type: string
            - type: object

    DataListResponse:
      type: object
      properties:
        objects:
          type: array
          items:
            $ref: '#/components/schemas/DataResponse'
        count:
          type: integer
          example: 10

    SchemaField:
      type: object
      required:
        - index
        - name
        - type
      properties:
        index:
          type: integer
          minimum: 1
          description: Field index (1-based, used in compact storage format)
          example: 1
        name:
          type: string
          description: Field name
          example: temperature
        type:
          type: string
          enum: [int8, int16, int32, int64, uint8, uint16, uint32, uint64, float32, float64, bool, string]
          description: Field data type
          example: float32

    SchemaRequest:
      type: object
      required:
        - fields
      properties:
        fields:
          type: array
          items:
            $ref: '#/components/schemas/SchemaField'
          description: Schema fields

    SchemaResponse:
      type: object
      properties:
        version:
          type: integer
          minimum: 1
          description: Schema version number
          example: 1
        fields:
          type: array
          items:
            $ref: '#/components/schemas/SchemaField'
          description: Schema fields

  responses:
    Unauthorized:
      description: Missing or invalid API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: unauthorized

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: not found
